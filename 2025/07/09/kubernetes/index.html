<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>kubernetes | Palette</title><meta name="author" content="Palette,1148432487@qq.com"><meta name="copyright" content="Palette"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="ffffff"><meta name="referrer" content="no-referrer"><meta name="description" content="基本概念虽然容器技术开启了云原生时代，但它也只走出了一小步，再继续前进就无能为力了，因为这已经不再是隔离一两个进程的普通问题，而是要隔离数不清的进程，还有它们之间互相通信、互相协作的超级问题，困难程度可以说是指数级别的上升。 这些容器之上的管理、调度工作，就是这些年最流行的词汇：“容器编排”（Container Orchestration）。 面对单机上的几个容器，“人肉”编排调度还可以应付，但如">
<meta property="og:type" content="article">
<meta property="og:title" content="kubernetes">
<meta property="og:url" content="https://palette-k.github.io/2025/07/09/kubernetes/index.html">
<meta property="og:site_name" content="Palette">
<meta property="og:description" content="基本概念虽然容器技术开启了云原生时代，但它也只走出了一小步，再继续前进就无能为力了，因为这已经不再是隔离一两个进程的普通问题，而是要隔离数不清的进程，还有它们之间互相通信、互相协作的超级问题，困难程度可以说是指数级别的上升。 这些容器之上的管理、调度工作，就是这些年最流行的词汇：“容器编排”（Container Orchestration）。 面对单机上的几个容器，“人肉”编排调度还可以应付，但如">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i0.hdslb.com/bfs/new_dyn/d6dbf7f189becdb2a1d2a843b67d4a7623452635.jpg@1192w.webp">
<meta property="article:published_time" content="2025-07-09T08:43:45.000Z">
<meta property="article:modified_time" content="2025-10-22T09:54:24.790Z">
<meta property="article:author" content="Palette">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i0.hdslb.com/bfs/new_dyn/d6dbf7f189becdb2a1d2a843b67d4a7623452635.jpg@1192w.webp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://palette-k.github.io/2025/07/09/kubernetes/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"KDCG4Y7LBT","apiKey":"d88d791bb15de311d25affcade475e37","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容：${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":200},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: Palette","link":"链接: ","source":"来源: Palette","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'mediumZoom',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'kubernetes',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-10-22 17:54:24'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', 'ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/css/article.css"><link rel="stylesheet" href="/css/tag.css"><link rel="stylesheet" href="/css/icon.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-categories-card@1.0.0/lib/categorybar.css"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Palette" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i0.hdslb.com/bfs/openplatform/bbcfc80924d36130665348ba84604566a29ccdc1.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://i0.hdslb.com/bfs/new_dyn/d6dbf7f189becdb2a1d2a843b67d4a7623452635.jpg@1192w.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="Palette"><span class="site-name">Palette</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">kubernetes</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-07-09T08:43:45.000Z" title="发表于 2025-07-09 16:43:45">2025-07-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-10-22T09:54:24.790Z" title="更新于 2025-10-22 17:54:24">2025-10-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">11.8k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>38分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="kubernetes"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><p>虽然容器技术开启了云原生时代，但它也只走出了一小步，再继续前进就无能为力了，因为这已经不再是隔离一两个进程的普通问题，而是要隔离数不清的进程，还有它们之间互相通信、互相协作的超级问题，困难程度可以说是指数级别的上升。</p>
<p>这些容器之上的管理、调度工作，就是这些年最流行的词汇：“<strong>容器编排</strong>”（Container Orchestration）。</p>
<p>面对单机上的几个容器，“人肉”编排调度还可以应付，但如果规模上到几百台服务器、成千上万的容器，处理它们之间的复杂联系就必须要依靠计算机了，而目前计算机用来调度管理的“事实标准”，就是：Kubernetes。</p>
<p>Kubernetes就是一个<strong>生产级别的容器编排平台和集群管理系统</strong>，不仅能够创建、调度容器，还能够监控、管理服务器。</p>
<h1 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h1><p><img src="https://i0.hdslb.com/bfs/openplatform/79bb57777a6a9f4496d72b0b436a15e1039038c9.png" alt="image-20250709171226550"></p>
<p>Kubernetes采用了现今流行的“<strong>控制面&#x2F;数据面</strong>”（Control Plane &#x2F; Data Plane）架构，集群里的计算机被称为“<strong>节点</strong>”（Node），可以是实机也可以是虚机，少量的节点用作控制面来执行集群的管理维护工作，其他的大部分节点都被划归数据面，用来跑业务应用。</p>
<p>控制面的节点在Kubernetes里叫做<strong>Master Node</strong>，一般简称为<strong>Master</strong>，它是整个集群里最重要的部分，可以说是Kubernetes的大脑和心脏。</p>
<p>数据面的节点叫做<strong>Worker Node</strong>，一般就简称为<strong>Worker</strong>或者<strong>Node</strong>，相当于Kubernetes的手和脚，在Master的指挥下干活。</p>
<p>Node的数量非常多，构成了一个资源池，Kubernetes就在这个池里分配资源，调度应用。因为资源被“池化”了，所以管理也就变得比较简单，可以在集群中任意添加或者删除节点。</p>
<p>在这张架构图里，我们还可以看到有一个kubectl，它就是Kubernetes的客户端工具，用来操作Kubernetes，但它位于集群之外，理论上不属于集群。</p>
<p>你可以使用命令 <code>kubectl get node</code> 来查看Kubernetes的节点状态：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get node</span><br></pre></td></tr></table></figure>

<p><img src="https://i0.hdslb.com/bfs/openplatform/dfd4a2527bef0983fad179df40bc3b305de1a6e5.png" alt="image-20250709171414500"></p>
<h2 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h2><p>Master里有4个组件，分别是<strong>apiserver</strong>、<strong>etcd</strong>、<strong>scheduler</strong>、<strong>controller-manager</strong>。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/2d59b019a9e9faeaa05cbba7953a42212b505735.png" alt="image-20250710101927564"></p>
<p>apiserver是Master节点——同时也是整个Kubernetes系统的唯一入口，它对外公开了一系列的RESTful API，并且加上了验证、授权等功能，所有其他组件都只能和它直接通信，可以说是Kubernetes里的联络员。</p>
<p>etcd是一个高可用的分布式Key-Value数据库，用来持久化存储系统里的各种资源对象和状态，相当于Kubernetes里的配置管理员。注意它只与apiserver有直接联系，也就是说任何其他组件想要读写etcd里的数据都必须经过apiserver。</p>
<p>scheduler负责容器的编排工作，检查节点的资源状态，把Pod调度到最适合的节点上运行，相当于部署人员。因为节点状态和Pod信息都存储在etcd里，所以scheduler必须通过apiserver才能获得。</p>
<p>controller-manager负责维护容器和节点等资源的状态，实现故障检测、服务迁移、应用伸缩等功能，相当于监控运维人员。同样地，它也必须通过apiserver获得存储在etcd里的信息，才能够实现对资源的各种操作。</p>
<p>这4个组件也都被容器化了，运行在集群的Pod里，我们可以用kubectl来查看它们的状态，使用命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod <span class="literal">-n</span> kube<span class="literal">-system</span></span><br></pre></td></tr></table></figure>

<h2 id="Worker-Node"><a href="#Worker-Node" class="headerlink" title="Worker Node"></a>Worker Node</h2><p><img src="https://i0.hdslb.com/bfs/openplatform/2d76640bd8013f0ed5517cf78e154cdfb0646e75.png" alt="image-20250710102645156"></p>
<p>kubelet是Node的代理，负责管理Node相关的绝大部分操作，Node上只有它能够与apiserver通信，实现状态报告、命令下发、启停容器等功能，相当于是Node上的一个“小管家”。</p>
<p>kube-proxy的作用有点特别，它是Node的网络代理，只负责管理容器的网络通信，简单来说就是为Pod转发TCP&#x2F;UDP数据包，相当于是专职的“小邮差”。</p>
<p>第三个组件container-runtime我们就比较熟悉了，它是容器和镜像的实际使用者，在kubelet的指挥下创建容器，管理Pod的生命周期，是真正干活的“苦力”。</p>
<h2 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h2><p>现在，我们再把Node里的组件和Master里的组件放在一起来看，就能够明白Kubernetes的大致工作流程了：</p>
<ul>
<li>每个Node上的kubelet会定期向apiserver上报节点状态，apiserver再存到etcd里。</li>
<li>每个Node上的kube-proxy实现了TCP&#x2F;UDP反向代理，让容器对外提供稳定的服务。</li>
<li>scheduler通过apiserver得到当前的节点状态，调度Pod，然后apiserver下发命令给某个Node的kubelet，kubelet调用container-runtime启动容器。</li>
<li>controller-manager也通过apiserver得到实时的节点状态，监控可能的异常情况，再使用相应的手段去调节恢复。</li>
</ul>
<h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><p>Docker Desktop 自带了 Kubernetes 支持，可以通过 Docker Desktop 的应用程序界面开启 Kubernetes 集群。</p>
<p>而且Docker Desktop 启动 Kubernetes 后，会自动配置 kubectl 命令行工具，便于我们日常学习，减少安装成本。</p>
<h2 id="Kuboard"><a href="#Kuboard" class="headerlink" title="Kuboard"></a>Kuboard</h2><p>Kuboard 是一款免费的 Kubernetes 管理工具，旨在帮助用户快速在 Kubernetes 上落地微服务。它提供了丰富的功能，包括但不限于 Kubernetes 基本管理功能、节点管理、名称空间管理、存储类&#x2F;存储卷管理、控制器管理、Service&#x2F;Ingress 管理、ConfigMap&#x2F;Secret 管理、CustomerResourceDefinition 管理、问题诊断、容器日志及终端、认证与授权、CI&#x2F;CD集成等。</p>
<p>拉取镜像：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull eipwork/kuboard:v3</span><br></pre></td></tr></table></figure>

<p>运行命令(挂载的路径需要更改)：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span>=kuboard <span class="literal">-p</span> <span class="number">8089</span>:<span class="number">80</span>/tcp <span class="literal">-p</span> <span class="number">10081</span>:<span class="number">10081</span>/tcp <span class="literal">-e</span> KUBOARD_ENDPOINT=<span class="string">&quot;http://192.168.3.220:8089&quot;</span> <span class="literal">-e</span> KUBOARD_AGENT_SERVER_TCP_PORT=<span class="string">&quot;10081&quot;</span> <span class="literal">-v</span> F:\docker\wsl\DockerDesktopWSL\mount\k8s eipwork/kuboard:v3</span><br></pre></td></tr></table></figure>

<p>访问 Kuboard：</p>
<p>地址： <a target="_blank" rel="noopener" href="http://127.0.0.1:8089/">http://127.0.0.1:8089/</a></p>
<p>账号：admin</p>
<p>密码：Kuboard123</p>
<p>登录进去后，<strong>添加 Kubernetes 集群到 Kuboard</strong></p>
<p>![image-20250709172637479](<a target="_blank" rel="noopener" href="https://i0.hdslb.com/bfs/openplatform/60c473e12d77b12fd152e25a23d26125f3574ac3.png">https://i0.hdslb.com/bfs/openplatform/60c473e12d77b12fd152e25a23d26125f3574ac3.png</a></p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/69a5b05ea94f6a685f67b5b03b86d009957df83c.png" alt="image-20250709175827891"></p>
<p>按照以下步骤执行：</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/7186fb0f2c24d373756ddafcc9ee8150aa7aa6a5.png" alt="image-20250709180129062"></p>
<p><strong>导入Kuboard</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> curl.exe <span class="literal">-k</span> <span class="string">&#x27;http://192.168.3.220:8089/kuboard-api/cluster/Ashley-k8s/kind/KubernetesCluster/Ashley-k8s/resource/installAgentToKubernetes?token=wfzV3KBKl48kGMr6lO6CQ2lIrDGdNj5j&#x27;</span> <span class="literal">-o</span> kuboard<span class="literal">-agent</span>.yaml</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line"><span class="number">100</span>  <span class="number">5611</span>    <span class="number">0</span>  <span class="number">5611</span>    <span class="number">0</span>     <span class="number">0</span>   <span class="number">314</span>k      <span class="number">0</span> <span class="literal">--</span>:<span class="literal">--</span>:<span class="literal">--</span> <span class="literal">--</span>:<span class="literal">--</span>:<span class="literal">--</span> <span class="literal">--</span>:<span class="literal">--</span>:<span class="literal">--</span>  <span class="number">322</span>k</span><br></pre></td></tr></table></figure>

<p>导入之前先要执行以下两个命令</p>
<p>获取当前 Kubernetes 集群中的所有 <code>Pod</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\jr10003509&gt; kubectl get pods</span><br><span class="line">No resources found <span class="keyword">in</span> default namespace.</span><br></pre></td></tr></table></figure>

<p>显示当前 Kubernetes 配置中所有上下文</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\jr10003509&gt; kubectl config <span class="built_in">get-contexts</span></span><br><span class="line">CURRENT   NAME             CLUSTER          AUTHINFO         NAMESPACE</span><br><span class="line">*         docker<span class="literal">-desktop</span>   docker<span class="literal">-desktop</span>   docker<span class="literal">-desktop</span></span><br></pre></td></tr></table></figure>

<p>切换 <code>kubectl</code> 操作的上下文到名为 <code>docker-desktop</code> 的上下文</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\jr10003509&gt; kubectl config <span class="built_in">use-context</span> docker<span class="literal">-desktop</span></span><br><span class="line">Switched to context <span class="string">&quot;docker-desktop&quot;</span>.</span><br></pre></td></tr></table></figure>

<p>获取（列出）当前 Kubernetes 集群中的所有节点（Node）的信息</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\jr10003509&gt; kubectl get nodes</span><br><span class="line">NAME             STATUS   ROLES           AGE   VERSION</span><br><span class="line">docker<span class="literal">-desktop</span>   Ready    control<span class="literal">-plane</span>   <span class="number">26</span>m   v1.<span class="number">28.2</span></span><br></pre></td></tr></table></figure>

<p>将本地文件 <code>.\kuboard-agent.yaml</code> 中定义的 <code>Kubernetes</code> 资源对象应用到 <code>Kubernetes</code> 集群中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\jr10003509&gt; kubectl apply <span class="operator">-f</span> ./kuboard<span class="literal">-agent</span>.yaml</span><br><span class="line">namespace/kuboard unchanged</span><br><span class="line">serviceaccount/kuboard<span class="literal">-admin</span> unchanged</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kuboard<span class="literal">-admin-crb</span> unchanged</span><br><span class="line">serviceaccount/kuboard<span class="literal">-viewer</span> unchanged</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kuboard<span class="literal">-viewer-crb</span> unchanged</span><br><span class="line">deployment.apps/kuboard<span class="literal">-agent-ashley</span> created</span><br><span class="line">deployment.apps/kuboard<span class="literal">-agent-ashley-2</span> created</span><br></pre></td></tr></table></figure>

<p>导入成功！</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/70902d2bfdd82244b17079d484f06c07c6a5290f.png" alt="image-20250709180841125"></p>
<h1 id="API对象"><a href="#API对象" class="headerlink" title="API对象"></a>API对象</h1><h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><p>Pod是对容器的“打包”，里面的容器是一个整体，总是能够一起调度、一起运行，绝不会出现分离的情况，而且Pod属于Kubernetes，可以在不触碰下层容器的情况下任意定制修改。</p>
<p>Kubernetes让Pod去编排处理容器，然后把Pod作为应用调度部署的<strong>最小单位</strong>，Pod也因此成为了Kubernetes世界里的“原子”（当然这个“原子”内部是有结构的，不是铁板一块），基于Pod就可以构建出更多更复杂的业务形态了。</p>
<h2 id="Job-CronJob"><a href="#Job-CronJob" class="headerlink" title="Job&#x2F;CronJob"></a>Job&#x2F;CronJob</h2><p>Kubernetes里有两大类业务。一类是像Nginx这样长时间运行的“<strong>在线业务</strong>”，另一类是像busybox这样短时间运行的“<strong>离线业务</strong>”。</p>
<p>“在线业务”类型的应用有很多，比如Nginx、Node.js、MySQL、Redis等等，一旦运行起来基本上不会停，也就是永远在线。</p>
<p>而“离线业务”类型的应用也并不少见，它们一般不直接服务于外部用户，只对内部用户有意义，比如日志分析、数据建模、视频转码等等，虽然计算量很大，但只会运行一段时间。“离线业务”的特点是<strong>必定会退出</strong>，不会无期限地运行下去，所以它的调度策略也就与“在线业务”存在很大的不同，需要考虑运行超时、状态检查、失败重试、获取计算结果等管理事项。</p>
<p>而这些业务特性与容器管理没有必然的联系，如果由Pod来实现就会承担不必要的义务，违反了“单一职责”，所以我们应该把这部分功能分离到另外一个对象上实现，让这个对象去控制Pod的运行，完成附加的工作。</p>
<p>“离线业务”也可以分为两种。一种是“<strong>临时任务</strong>”，跑完就完事了，下次有需求了说一声再重新安排；另一种是“<strong>定时任务</strong>”，可以按时按点周期运行，不需要过多干预。</p>
<p>对应到Kubernetes里，“临时任务”就是API对象<strong>Job</strong>，“定时任务”就是API对象<strong>CronJob</strong>，使用这两个对象你就能够在Kubernetes里调度管理任意的离线业务了。</p>
<p>可以看到，Job对象里应用了组合模式，<code>template</code> 字段定义了一个“<strong>应用模板</strong>”，里面嵌入了一个Pod，这样Job就可以从这个模板来创建出Pod。而这个Pod因为受Job的管理控制，不直接和apiserver打交道，也就没必要重复apiVersion等“头字段”，只需要定义好关键的 <code>spec</code>，描述清楚容器相关的信息就可以了，可以说是一个“无头”的Pod对象。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/c0824e862bf99bc953f78ffe2f66d9503bee7086.png" alt="image-20250710111135700"></p>
<p>而定时任务”的CronJob对象也很好理解了，使用schedule指定了执行周期，又组合了Job而生成的新对象。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/b1bcabe3ca8354818e418913c673451e73d8a837.png" alt="image-20250710111413288"></p>
<p>CronJob使用定时规则控制Job，Job使用并发数量控制Pod，Pod再定义参数控制容器，容器再隔离控制进程，进程最终实现业务功能，层层递进的形式有点像设计模式里的Decorator（装饰模式），链条里的每个环节都各司其职，在Kubernetes的统一指挥下完成任务。</p>
<h2 id="Deployment：让应用永不宕机"><a href="#Deployment：让应用永不宕机" class="headerlink" title="Deployment：让应用永不宕机"></a>Deployment：让应用永不宕机</h2><p>在线业务远不是单纯启动一个Pod这么简单，还有多实例、高可用、版本更新等许多复杂的操作。比如最简单的多实例需求，为了提高系统的服务能力，应对突发的流量和压力，我们需要创建多个应用的副本，还要即时监控它们的状态。如果还是只使用Pod，那就会又走回手工管理的老路，没有利用好Kubernetes自动化运维的优势。</p>
<p>Deployment，就是用来管理Pod，实现在线业务应用的新API对象。</p>
<p> <code>replicas</code> 字段。它的含义比较简单明了，就是“副本数量”的意思，也就是说，指定要在Kubernetes集群里运行多少个Pod实例。</p>
<p>接下来Kubernetes还会持续地监控Pod的运行状态，万一有Pod发生意外消失了，数量不满足“期望状态”，它就会通过apiserver、scheduler等核心组件去选择新的节点，创建出新的Pod，直至数量与“期望状态”一致。</p>
<p> <code>selector</code>，它的作用是“筛选”出要被Deployment管理的Pod对象，下属字段“<strong>matchLabels</strong>”定义了Pod对象应该携带的label，它必须和“template”里Pod定义的“labels”完全相同，否则Deployment就会找不到要控制的Pod对象，apiserver也会告诉你YAML格式校验错误无法创建。</p>
<p>Kubernetes采用的是这种“贴标签”的方式，通过在API对象的“metadata”元信息里加各种标签（labels），我们就可以使用类似关系数据库里查询语句的方式，筛选出具有特定标识的那些对象。<strong>通过标签这种设计，Kubernetes就解除了Deployment和模板里Pod的强绑定，把组合关系变成了“弱引用”</strong>。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/f50ba2a6e58009faefceefa1106ef497dc22df56.png" alt="image-20250710115117565"></p>
<p><strong>在Deployment部署成功之后，你还可以随时调整Pod的数量，实现所谓的“应用伸缩”</strong>。这项工作在Kubernetes出现之前对于运维来说是一件很困难的事情，而现在由于有了Deployment就变得轻而易举了。</p>
<h2 id="DaemonSet：节点的守护者"><a href="#DaemonSet：节点的守护者" class="headerlink" title="DaemonSet：节点的守护者"></a>DaemonSet：节点的守护者</h2><p>Deployment并不关心这些Pod会在集群的哪些节点上运行，<strong>在它看来，Pod的运行环境与功能是无关的，只要Pod的数量足够，应用程序应该会正常工作</strong>。</p>
<p>这个假设对于大多数业务来说是没问题的，比如Nginx、WordPress、MySQL，它们不需要知道集群、节点的细节信息，只要配置好环境变量和存储卷，在哪里“跑”都是一样的。</p>
<p>但是有一些业务比较特殊，它们不是完全独立于系统运行的，而是与主机存在“绑定”关系，必须要依附于节点才能产生价值，比如说：</p>
<ul>
<li>网络应用（如kube-proxy），必须每个节点都运行一个Pod，否则节点就无法加入Kubernetes网络。</li>
<li>监控应用（如Prometheus），必须每个节点都有一个Pod用来监控节点的状态，实时上报信息。</li>
<li>日志应用（如Fluentd），必须在每个节点上运行一个Pod，才能够搜集容器运行时产生的日志数据。</li>
<li>安全应用，同样的，每个节点都要有一个Pod来执行安全审计、入侵检查、漏洞扫描等工作。</li>
</ul>
<p>所以，Kubernetes就定义了新的API对象DaemonSet，它在形式上和Deployment类似，都是管理控制Pod，但管理调度策略却不同。DaemonSet的目标是在集群的每个节点上运行且仅运行一个Pod，就好像是为节点配上一只“看门狗”，忠实地“守护”着节点，这就是DaemonSet名字的由来。</p>
<p>DaemonSet仅仅是在Pod的部署调度策略上和Deployment不同，其他的都是相同的，某种程度上我们也可以把DaemonSet看做是Deployment的一个特例。</p>
<p>我还是把YAML描述文件画了一张图，好让你看清楚与Deployment的差异：</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/ed917d93f0354d88671162e734856f1f935a6229.png" alt="image-20250710141911055"></p>
<h1 id="配置管理"><a href="#配置管理" class="headerlink" title="配置管理"></a>配置管理</h1><p>首先你要知道，应用程序有很多类别的配置信息，但从数据安全的角度来看可以分成两类：</p>
<ul>
<li>一类是明文配置，也就是不保密，可以任意查询修改，比如服务端口、运行参数、文件路径等等。</li>
<li>另一类则是机密配置，由于涉及敏感信息需要保密，不能随便查看，比如密码、密钥、证书等等。</li>
</ul>
<p>这两类配置信息本质上都是字符串，只是由于安全性的原因，在存放和使用方面有些差异，所以Kubernetes也就定义了两个API对象，<strong>ConfigMap</strong>用来保存明文配置，<strong>Secret</strong>用来保存秘密配置。</p>
<p>因为ConfigMap和Secret只是一些存储在etcd里的字符串，所以如果想要在运行时产生效果，就必须要以某种方式“<strong>注入</strong>”到Pod里，让应用去读取。在这方面的处理上Kubernetes和Docker是一样的，也是两种途径：<strong>环境变量</strong>和<strong>加载文件</strong>。</p>
<h2 id="环境变量注入"><a href="#环境变量注入" class="headerlink" title="环境变量注入"></a>环境变量注入</h2><p>从这张图你就应该能够比较清楚地看出Pod与ConfigMap、Secret的“松耦合”关系，它们不是直接嵌套包含，而是使用“KeyRef”字段间接引用对象，这样，同一段配置信息就可以在不同的对象之间共享。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/8e60029d79e1da7e50de61ed9749eeefe1da454e.png" alt="image-20250710113004281"></p>
<h2 id="文件加载注入"><a href="#文件加载注入" class="headerlink" title="文件加载注入"></a>文件加载注入</h2><p>Kubernetes为Pod定义了一个“<strong>Volume</strong>”的概念，可以翻译成是“存储卷”。如果把Pod理解成是一个虚拟机，那么Volume就相当于是虚拟机里的磁盘。</p>
<p>我们可以为Pod“挂载（mount）”多个Volume，里面存放供Pod访问的数据，这种方式有点类似 <code>docker run -v</code>，虽然用法复杂了一些，但功能也相应强大一些。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/b7f9270835ea7ba5452a9515c7f37d34a0c1735c.png" alt="image-20250710113256011"></p>
<p>挂载Volume的方式和环境变量又不太相同。环境变量是直接引用了ConfigMap&#x2F;Secret，而Volume又多加了一个环节，需要先用Volume引用ConfigMap&#x2F;Secret，然后在容器里挂载Volume。</p>
<p>这种方式的好处在于：以Volume的概念统一抽象了所有的存储，不仅现在支持ConfigMap&#x2F;Secret，以后还能够支持临时卷、持久卷、动态卷、快照卷等许多形式的存储，扩展性非常好。</p>
<p>因为这种形式上的差异，以Volume的方式来使用ConfigMap&#x2F;Secret，就和环境变量不太一样。环境变量用法简单，更适合存放简短的字符串，而Volume更适合存放大数据量的配置文件，在Pod里加载成文件后让应用直接读取使用。</p>
<h1 id="Service：微服务架构的应对之道"><a href="#Service：微服务架构的应对之道" class="headerlink" title="Service：微服务架构的应对之道"></a>Service：微服务架构的应对之道</h1><p>在Kubernetes集群里Pod的生命周期是比较“短暂”的，虽然Deployment和DaemonSet可以维持Pod总体数量的稳定，但在运行过程中，难免会有Pod销毁又重建，这就会导致Pod集合处于动态的变化之中。</p>
<p>这种“动态稳定”对于现在流行的微服务架构来说是非常致命的，试想一下，后台Pod的IP地址老是变来变去，客户端该怎么访问呢？如果不处理好这个问题，Deployment和DaemonSet把Pod管理得再完善也是没有价值的。</p>
<p>其实，这个问题也并不是什么难事，业内早就有解决方案来针对这样“不稳定”的后端服务，那就是“<strong>负载均衡</strong>”，典型的应用有LVS、Nginx等等。它们在前端与后端之间加入了一个“中间层”，屏蔽后端的变化，为前端提供一个稳定的服务。</p>
<p>但LVS、Nginx毕竟不是云原生技术，所以Kubernetes就按照这个思路，定义了新的API对象：<strong>Service</strong>。</p>
<p>Kubernetes会给Service分配一个静态IP地址，然后它再去自动管理、维护后面动态变化的Pod集合，当客户端访问Service，它就根据某种策略，把流量转发给后面的某个Pod。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/516cf8ccd1a88d24082699e5e3c0c5b499b40e49.png" alt="image-20250710145331433"></p>
<p><code>selector</code> 和Deployment&#x2F;DaemonSet里的作用是一样的，用来过滤出要代理的那些Pod。因为我们指定要代理Deployment，所以Kubernetes就为我们自动填上了ngx-dep的标签，会选择这个Deployment对象部署的所有Pod。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/e9e6e6f453efca2e173de96475441c69b13fb2ff.png" alt="image-20250710145555926"></p>
<p>Pod被Deployment对象管理，删除后会自动重建，而Service又会通过controller-manager实时监控Pod的变化情况，所以就会立即更新它代理的IP地址。</p>
<h2 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h2><p>Kubernetes有一个默认的名字空间，叫“<strong>default</strong>”，如果不显式指定，API对象都会在这个“default”名字空间里。而其他的名字空间都有各自的用途，比如“kube-system”就包含了apiserver、etcd等核心组件的Pod。</p>
<p>通常我们会使用namespce区分线上环境。</p>
<p>Service对象的域名完全形式是“<strong>对象.名字空间.svc.cluster.local</strong>”，但很多时候也可以省略后面的部分，直接写“<strong>对象.名字空间</strong>”甚至“<strong>对象名</strong>”就足够了，默认会使用对象所在的名字空间（比如这里就是default）。</p>
<p>我们不再关心Service对象的IP地址，只需要知道它的名字，就可以用DNS的方式去访问后端服务。</p>
<h1 id="Ingress：集群进出流量的总管"><a href="#Ingress：集群进出流量的总管" class="headerlink" title="Ingress：集群进出流量的总管"></a>Ingress：集群进出流量的总管</h1><p><strong>Ingress的意思是集群内外边界上的入口，它作为流量的总入口，统管集群的进出口数据</strong>，“扇入”“扇出”流量（也就是我们常说的“南北向”），让外部用户能够安全、顺畅、便捷地访问内部服务。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/fef1938ec77144482a19e396dc7dd2fd59235dcd.png" alt="image-20250710174017411"></p>
<p>再对比一下Service我们就能更透彻地理解Ingress。</p>
<p>Ingress可以说是在七层上另一种形式的Service，它同样会代理一些后端的Pod，也有一些路由规则来定义流量应该如何分配、转发，只不过这些规则都使用的是HTTP&#x2F;HTTPS协议。</p>
<p>你应该知道，Service本身是没有服务能力的，它只是一些iptables规则，<strong>真正配置、应用这些规则的实际上是节点里的kube-proxy组件</strong>。如果没有kube-proxy，Service定义得再完善也没有用。</p>
<p>同样的，Ingress也只是一些HTTP路由规则的集合，相当于一份静态的描述文件，真正要把这些规则在集群里实施运行，还需要有另外一个东西，这就是 <code>Ingress Controller</code>，它的作用就相当于Service的kube-proxy，能够读取、应用Ingress规则，处理、调度流量。</p>
<p>理来说，Kubernetes应该把Ingress Controller内置实现，作为基础设施的一部分，就像kube-proxy一样。</p>
<p><strong>不过Ingress Controller要做的事情太多，与上层业务联系太密切，所以Kubernetes把Ingress Controller的实现交给了社区</strong>，任何人都可以开发Ingress Controller，只要遵守Ingress规则就好。</p>
<p>这就造成了Ingress Controller“百花齐放”的盛况。</p>
<p>由于Ingress Controller把守了集群流量的关键入口，掌握了它就拥有了控制集群应用的“话语权”，所以众多公司纷纷入场，精心打造自己的Ingress Controller，意图在Kubernetes流量进出管理这个领域占有一席之地。</p>
<p>这些实现中最著名的，就是老牌的反向代理和负载均衡软件Nginx了。从Ingress Controller的描述上我们也可以看到，HTTP层面的流量管理、安全控制等功能其实就是经典的反向代理，而Nginx则是其中稳定性最好、性能最高的产品，所以它也理所当然成为了Kubernetes里应用得最广泛的Ingress Controller。</p>
<p>根据Docker Hub上的统计，<strong>Nginx公司的开发实现是下载量最多的Ingress Controller</strong>，所以我将以它为例，讲解Ingress和Ingress Controller的用法。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/c4aab8c9306f5ef219e3edc97d4fb0a1774d7ba6.png" alt="image-20250710174349077"></p>
<h2 id="IngressClass"><a href="#IngressClass" class="headerlink" title="IngressClass"></a>IngressClass</h2><p>那么到现在，有了Ingress和Ingress Controller，我们是不是就可以完美地管理集群的进出流量了呢？</p>
<p>最初Kubernetes也是这么想的，一个集群里有一个Ingress Controller，再给它配上许多不同的Ingress规则，应该就可以解决请求的路由和分发问题了。</p>
<p>但随着Ingress在实践中的大量应用，很多用户发现这种用法会带来一些问题，比如：</p>
<ul>
<li>由于某些原因，项目组需要引入不同的Ingress Controller，但Kubernetes不允许这样做；</li>
<li>Ingress规则太多，都交给一个Ingress Controller处理会让它不堪重负；</li>
<li>多个Ingress对象没有很好的逻辑分组方式，管理和维护成本很高；</li>
<li>集群里有不同的租户，他们对Ingress的需求差异很大甚至有冲突，无法部署在同一个Ingress Controller上。</li>
</ul>
<p>所以，Kubernetes就又提出了一个 <code>Ingress Class</code> 的概念，让它插在Ingress和Ingress Controller中间，作为流量规则和控制器的协调人，解除了Ingress和Ingress Controller的强绑定关系。</p>
<p>现在，<strong>Kubernetes用户可以转向管理Ingress Class，用它来定义不同的业务逻辑分组，简化Ingress规则的复杂度</strong>。比如说，我们可以用Class A处理博客流量、Class B处理短视频流量、Class C处理购物流量。</p>
<p>有了Ingress Controller，这些API对象的关联就更复杂了，你可以用下面的这张图来看出它们是如何使用对象名字联系起来的：</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/cb7dff89b0e7076adfc7a1e0b13c1ec3d535cd91.png" alt="image-20250710174938720"></p>
<h1 id="PersistentVolume：数据持久化"><a href="#PersistentVolume：数据持久化" class="headerlink" title="PersistentVolume：数据持久化"></a>PersistentVolume：数据持久化</h1><p>前面说到，pod是kubernetes中运行的最小单位，但是其中存在一个很严重的问题：Pod没有持久化功能，因为Pod里的容器是由镜像产生的，而镜像文件本身是只读的，进程要读写磁盘只能用一个临时的存储空间，一旦Pod销毁，临时存储也就会立即回收释放，数据也就丢失了。</p>
<p>为了保证即使Pod销毁后重建数据依然存在，我们就需要找出一个解决方案，让Pod用上真正的“虚拟盘”。Kubernetes延伸出了<strong>PersistentVolume</strong>对象，它专门用来表示持久存储设备。<strong>作为存储的抽象，PV实际上就是一些存储设备、文件系统</strong>，比如Ceph、GlusterFS、NFS，甚至是本地磁盘，管理它们已经超出了Kubernetes的能力范围，所以，一般会由系统管理员单独维护，然后再在Kubernetes里创建对应的PV。</p>
<p>要注意的是，PV属于集群的系统资源，是和Node平级的一种对象，Pod对它没有管理权，只有使用权。</p>
<h2 id="PersistentVolumeClaim"><a href="#PersistentVolumeClaim" class="headerlink" title="PersistentVolumeClaim"></a>PersistentVolumeClaim</h2><p>PersistentVolumeClaim，简称PVC，从名字上看比较好理解，就是用来向Kubernetes申请存储资源的。PVC是给Pod使用的对象，它相当于是Pod的代理，代表Pod向系统申请PV。一旦资源申请成功，Kubernetes就会把PV和PVC关联在一起，这个动作叫做“<strong>绑定</strong>”（bind）。</p>
<p>但是，系统里的存储资源非常多，如果要PVC去直接遍历查找合适的PV也很麻烦，所以就要用到StorageClass。</p>
<h2 id="StorageClass"><a href="#StorageClass" class="headerlink" title="StorageClass"></a>StorageClass</h2><p>StorageClass抽象了特定类型的存储系统（比如Ceph、NFS），在PVC和PV之间充当“协调人”的角色，帮助PVC找到合适的PV。也就是说它可以简化Pod挂载“虚拟盘”的过程，让Pod看不到PV的实现细节。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/cf9a383122edf826ccd7ece51440ae077ecab02e.png" alt="image-20250711153617343"></p>
<h1 id="StatefulSet：管理有状态的应用"><a href="#StatefulSet：管理有状态的应用" class="headerlink" title="StatefulSet：管理有状态的应用"></a>StatefulSet：管理有状态的应用</h1><p>用Deployment来保证高可用，用PersistentVolume来存储数据，确实可以部分达到管理“有状态应用”的目的。但“状态”不仅仅是数据持久化，在集群化、分布式的场景里，还有多实例的依赖关系、启动顺序和网络标识等问题需要解决，而这些问题恰恰是Deployment力所不及的。</p>
<p>因为只使用Deployment，多个实例之间是无关的，启动的顺序不固定，Pod的名字、IP地址、域名也都是完全随机的，这正是“无状态应用”的特点。</p>
<p>但对于“有状态应用”，多个实例之间可能存在依赖关系，比如master&#x2F;slave、active&#x2F;passive，需要依次启动才能保证应用正常运行，外界的客户端也可能要使用固定的网络标识来访问实例，而且这些信息还必须要保证在Pod重启后不变。</p>
<p>所以，Kubernetes就在Deployment的基础之上定义了一个新的API对象，名字也很好理解，就叫StatefulSet，专门用来管理有状态的应用。</p>
<p>前面提到，Service自己会有一个域名，格式是“<strong>对象名.名字空间</strong>”，每个Pod也会有一个域名，形式是“<strong>IP地址.名字空间</strong>”。但因为IP地址不稳定，所以Pod的域名并不实用，一般我们会使用稳定的Service域名。</p>
<p>当我们把Service对象应用于StatefulSet的时候，情况就不一样了。</p>
<p>Service发现这些Pod不是一般的应用，而是有状态应用，需要有稳定的网络标识，所以就会为Pod再多创建出一个新的域名，格式是“<strong>Pod名.服务名.名字空间.svc.cluster.local</strong>”。当然，这个域名也可以简写成“<strong>Pod名.服务名</strong>”。</p>
<p>显然，在StatefulSet里的这两个Pod都有了各自的域名，也就是稳定的网络标识。那么接下来，外部的客户端只要知道了StatefulSet对象，就可以用固定的编号去访问某个具体的实例了，虽然Pod的IP地址可能会变，但这个有编号的域名由Service对象维护，是稳定不变的。</p>
<h2 id="StatefulSet的数据持久化"><a href="#StatefulSet的数据持久化" class="headerlink" title="StatefulSet的数据持久化"></a>StatefulSet的数据持久化</h2><p>现在StatefulSet已经有了固定的名字、启动顺序和网络标识，只要再给它加上数据持久化功能，我们就可以实现对“有状态应用”的管理了。</p>
<p>不过，为了强调持久化存储与StatefulSet的一对一绑定关系，Kubernetes为StatefulSet专门定义了一个字段“<strong>volumeClaimTemplates</strong>”，直接把PVC定义嵌入StatefulSet的YAML文件里。这样能保证创建StatefulSet的同时，就会为每个Pod自动创建PVC，让StatefulSet的可用性更高。</p>
<h1 id="滚动更新：平滑的应用升降级"><a href="#滚动更新：平滑的应用升降级" class="headerlink" title="滚动更新：平滑的应用升降级"></a>滚动更新：平滑的应用升降级</h1><h2 id="应用升级"><a href="#应用升级" class="headerlink" title="应用升级"></a>应用升级</h2><p>在Kubernetes里，版本更新使用的不是API对象，而是两个命令：<code>kubectl apply</code> 和 <code>kubectl rollout</code>，当然它们也要搭配部署应用所需要的Deployment、DaemonSet等YAML文件。</p>
<p>Kubernetes里应用都是以Pod的形式运行的，而Pod通常又会被Deployment等对象来管理，<strong>所以应用的“版本更新”实际上更新的是整个Pod</strong>。</p>
<p>Pod是由YAML描述文件来确定的，更准确地说，是Deployment等对象里的字段 <code>template</code>。所以，<strong>在Kubernetes里应用的版本变化就是 <code>template</code> 里Pod的变化</strong>，哪怕 <code>template</code> 里只变动了一个字段，那也会形成一个新的版本，也算是版本变化。</p>
<p>Kubernetes不是把旧Pod全部销毁再一次性创建出新Pod，而是在逐个地创建新Pod，同时也在销毁旧Pod，保证系统里始终有足够数量的Pod在运行，不会有“空窗期”中断服务。</p>
<p>新Pod数量增加的过程有点像是“滚雪球”，从零开始，越滚越大，所以这就是所谓的“<strong>滚动更新</strong>”（rolling update）。</p>
<p>其实“滚动更新”就是由Deployment控制的两个同步进行的“应用伸缩”操作，老版本缩容到0，同时新版本扩容到指定值，是一个“此消彼长”的过程。</p>
<p>生产环境中就有关于应用无感发布的例子，只要开启了健康检测，且3次不通过，启动检测和存活检测不通过会将 pod 重启，就绪检测不通过会把 pod 从 svc EndPoint 列表列表中删除，请求不会打到此 pod 上。如果生产上  pod 出现了某些异常，会创建一个新的 pod，等到新的pod健康检测完成以后，才会把旧 pod 从 endpoint 列表中移出，新 pod 加入，此时旧 pod 已经不会接收到新请求了，旧 pod 会把一些没有完成的请求正常响应，响应完才会销毁掉，<code>terminationGracePeriodSecond</code> 这个参数配置表明  Pod 在收到终止信号后，允许其正常关闭的最大宽限时间，在这段时间内可以处理剩余请求。</p>
<h2 id="应用回滚"><a href="#应用回滚" class="headerlink" title="应用回滚"></a>应用回滚</h2><p>对于更新后出现的问题，Kubernetes为我们提供了“后悔药”，也就是更新历史，你可以查看之前的每次更新记录，并且回退到任何位置，和我们开发常用的Git等版本控制软件非常类似。</p>
<p>如果想要回退到上一个版本，就可以使用命令 <code>kubectl rollout undo</code>，也可以加上参数 <code>--to-revision</code> 回退到任意一个历史版本。<code>kubectWl rollout undo</code> 的操作过程其实和 <code>kubectl apply</code> 是一样的，执行的仍然是“滚动更新”，只不过使用的是旧版本Pod模板，把新版本Pod数量收缩到0，同时把老版本Pod扩展到指定值。</p>
<h1 id="应用保障：如何让Pod运行得更健康？"><a href="#应用保障：如何让Pod运行得更健康？" class="headerlink" title="应用保障：如何让Pod运行得更健康？"></a>应用保障：如何让Pod运行得更健康？</h1><h2 id="容器资源配额"><a href="#容器资源配额" class="headerlink" title="容器资源配额"></a>容器资源配额</h2><p>创建容器有三大隔离技术：namespace、cgroup、chroot。其中的namespace实现了独立的进程空间，cgroup的作用是管控CPU、内存，保证容器不会无节制地占用基础资源，进而影响到系统里的其他应用，chroot实现了独立的文件系统。</p>
<p>与PersistentVolumeClaim用法有些类似，就是容器需要先提出一个“书面申请”，Kubernetes再依据这个“申请”决定资源是否分配和如何分配。使用 <code>resources</code> 字段加上资源配额之后，Pod在Kubernetes里的运行就有了初步保障，Kubernetes会监控Pod的资源使用情况，让它既不会“饿死”也不会“撑死”。</p>
<p>Kubernetes会根据每个Pod声明的需求，像搭积木或者玩俄罗斯方块一样，把节点尽量“塞满”，充分利用每个节点的资源，让集群的效益最大化。</p>
<h2 id="容器状态探针"><a href="#容器状态探针" class="headerlink" title="容器状态探针"></a>容器状态探针</h2><p>一个程序即使正常启动了，它也有可能因为某些原因无法对外提供服务。其中最常见的情况就是运行时发生“死锁”或者“死循环”的故障，这个时候从外部来看进程一切都是正常的，但内部已经是一团糟了。</p>
<p>Kubernetes为检查应用状态定义了三种探针，它们分别对应容器不同的状态：</p>
<ul>
<li><strong>Startup</strong>，启动探针，用来检查应用是否已经启动成功，适合那些有大量初始化工作要做，启动很慢的应用。</li>
<li><strong>Liveness</strong>，存活探针，用来检查应用是否正常运行，是否存在死锁、死循环。</li>
<li><strong>Readiness</strong>，就绪探针，用来检查应用是否可以接收流量，是否能够对外提供服务。</li>
</ul>
<p>你需要注意这三种探针是递进的关系：应用程序先启动，加载完配置文件等基本的初始化数据就进入了Startup状态，之后如果没有什么异常就是Liveness存活状态，但可能有一些准备工作没有完成，还不一定能对外提供服务，只有到最后的Readiness状态才是一个容器最健康可用的状态。</p>
<p>那Kubernetes具体是如何使用状态和探针来管理容器的呢？</p>
<p>如果一个Pod里的容器配置了探针，<strong>Kubernetes在启动容器后就会不断地调用探针来检查容器的状态</strong>：</p>
<ul>
<li>如果Startup探针失败，Kubernetes会认为容器没有正常启动，就会尝试反复重启，当然其后面的Liveness探针和Readiness探针也不会启动。</li>
<li>如果Liveness探针失败，Kubernetes就会认为容器发生了异常，也会重启容器。</li>
<li>如果Readiness探针失败，Kubernetes会认为容器虽然在运行，但内部有错误，不能正常提供服务，就会把容器从Service对象的负载均衡集合中排除，不会给它分配流量。</li>
</ul>
<p><img src="https://i0.hdslb.com/bfs/openplatform/76404447854f331194c43631155b944c36c2d4e7.png" alt="image-20250711172041991"></p>
<h1 id="集群管理：如何用名字空间分隔系统资源？"><a href="#集群管理：如何用名字空间分隔系统资源？" class="headerlink" title="集群管理：如何用名字空间分隔系统资源？"></a>集群管理：如何用名字空间分隔系统资源？</h1><p>Kubernetes的名字空间并不是一个实体对象，只是一个逻辑上的概念。它可以把集群切分成一个个彼此独立的区域，然后我们把对象放到这些区域里，就实现了类似容器技术里namespace的隔离效果，应用只能在自己的名字空间里分配资源和运行，不会干扰到其他名字空间里的应用。</p>
<h2 id="资源配额"><a href="#资源配额" class="headerlink" title="资源配额"></a>资源配额</h2><p>有了名字空间，我们就可以像管理容器一样，给名字空间设定配额，把整个集群的计算资源分割成不同的大小，按需分配给团队或项目使用。</p>
<p>不过集群和单机不一样，除了限制最基本的CPU和内存，还必须限制各种对象的数量，否则对象之间也会互相挤占资源。</p>
<h2 id="默认资源配额"><a href="#默认资源配额" class="headerlink" title="默认资源配额"></a>默认资源配额</h2><p>学到这里估计你也发现了，在名字空间加上了资源配额限制之后，它会有一个合理但比较“烦人”的约束：要求所有在里面运行的Pod都必须用字段 <code>resources</code> 声明资源需求，否则就无法创建。</p>
<p>Kubernetes这样做的原因也很好理解，如果Pod里没有 <code>resources</code> 字段，就可以无限制地使用CPU和内存，这显然与名字空间的资源配额相冲突。<strong>为了保证名字空间的资源总量可管可控，Kubernetes就只能拒绝创建这样的Pod了。</strong></p>
<p>那么能不能让Kubernetes自动为Pod加上资源限制呢？也就是说给个默认值，这样就可以省去反复设置配额的烦心事。</p>
<p>这个时候就要用到一个<strong>很小但很有用的辅助对象了—— <code>LimitRange</code>，简称是 <code>limits</code>，它能为API对象添加默认的资源配额限制</strong>。</p>
<h1 id="系统监控：如何使用Metrics-Server和Prometheus？"><a href="#系统监控：如何使用Metrics-Server和Prometheus？" class="headerlink" title="系统监控：如何使用Metrics Server和Prometheus？"></a>系统监控：如何使用Metrics Server和Prometheus？</h1><p>希望给集群也安装上“检查探针”，观察到集群的资源利用率和其他指标，让集群的整体运行状况对我们“透明可见”，这样才能更准确更方便地做好集群的运维工作。</p>
<h2 id="Metrics-Server"><a href="#Metrics-Server" class="headerlink" title="Metrics Server"></a>Metrics Server</h2><p>Metrics Server是一个专门用来收集Kubernetes核心资源指标（metrics）的工具，它定时从所有节点的kubelet里采集信息，但是对集群的整体性能影响极小，每个节点只大约会占用1m的CPU和2MB的内存，所以性价比非常高。</p>
<p>它调用kubelet的API拿到节点和Pod的指标，再把这些信息交给apiserver，这样kubectl、HPA就可以利用apiserver来读取指标了：</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/a3506f759b38d478201c9ae99c841c0e5082fd54.png" alt="image-20250711172952961"></p>
<h2 id="HorizontalPodAutoscaler"><a href="#HorizontalPodAutoscaler" class="headerlink" title="HorizontalPodAutoscaler"></a>HorizontalPodAutoscaler</h2><p>有了Metrics Server，我们就可以轻松地查看集群的资源使用状况了，不过它另外一个更重要的功能是辅助实现应用的“<strong>水平自动伸缩</strong>”。</p>
<p>“<strong>HorizontalPodAutoscaler</strong>”，简称是“<strong>hpa</strong>”。顾名思义，它是专门用来自动伸缩Pod数量的对象，适用于Deployment和StatefulSet，但不能用于DaemonSet。</p>
<p>HorizontalPodAutoscaler的能力完全基于Metrics Server，它从Metrics Server获取当前应用的运行指标，主要是CPU使用率，再依据预定的策略增加或者减少Pod的数量。</p>
<p>因为Metrics Server大约每15秒采集一次数据，所以HorizontalPodAutoscaler的自动化扩容和缩容也是按照这个时间点来逐步处理的。</p>
<p>当它发现目标的CPU使用率超过了预定的5%后，就会以2的倍数开始扩容，一直到数量上限，然后持续监控一段时间，如果CPU使用率回落，就会再缩容到最小值。</p>
<h2 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h2><p>显然，有了Metrics Server和HorizontalPodAutoscaler的帮助，我们的应用管理工作又轻松了一些。不过，Metrics Server能够获取的指标还是太少了，只有CPU和内存，想要监控到更多更全面的应用运行状况，还得请出这方面的权威项目“<strong>Prometheus</strong>”。</p>
<p><img src="https://i0.hdslb.com/bfs/openplatform/bacc77beade046913111576c813dbc1027ebdf7e.png" alt="image-20250711173914580"></p>
<p>Prometheus系统的核心是它的Server，里面有一个时序数据库TSDB，用来存储监控数据，另一个组件Retrieval使用拉取（Pull）的方式从各个目标收集数据，再通过HTTP Server把这些数据交给外界使用。</p>
<p>在Prometheus Server之外还有三个重要的组件：</p>
<ul>
<li>Push Gateway，用来适配一些特殊的监控目标，把默认的Pull模式转变为Push模式。</li>
<li>Alert Manager，告警中心，预先设定规则，发现问题时就通过邮件等方式告警。</li>
<li>Grafana是图形化界面，可以定制大量直观的监控仪表盘。</li>
</ul>
<h1 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h1><p>Kubernetes提出了一个自己的网络模型“<strong>IP-per-pod</strong>”，能够很好地适应集群系统的网络需求，它有下面的这4点基本假设：</p>
<ul>
<li>集群里的每个Pod都会有唯一的一个IP地址。</li>
<li>Pod里的所有容器共享这个IP地址。</li>
<li>集群里的所有Pod都属于同一个网段。</li>
<li>Pod直接可以基于IP地址直接访问另一个Pod，不需要做麻烦的网络地址转换（NAT）。</li>
</ul>
<h1 id="内部k8s亲和性配置规范说明"><a href="#内部k8s亲和性配置规范说明" class="headerlink" title="内部k8s亲和性配置规范说明"></a>内部k8s亲和性配置规范说明</h1><blockquote>
<p><em>注意运行中的节点。谨慎添加</em><code>NoExecute</code><em>属性</em><code>污点标签</code><em>,否则会导致节点中服务被驱逐。造成生产事故</em></p>
</blockquote>
<p>节点资源类型目前分四种</p>
<ul>
<li>非核心组 8核32G 标签：<code>jr.k8s.node/group:non-core</code></li>
<li>核心组 16核64G 标签：<code>jr.k8s.node/group:core</code>，<code>污点标签</code>：<code>jr.k8s.node/group:task:core</code></li>
<li>任务组 8核64G 标签：<code>jr.k8s.node/group:task</code>，<code>污点标签</code>：<code>jr.k8s.node/group:task:NoExecute</code>（待实现云托管，取消该标签）</li>
<li>专属节点 8核32G 标签：<code>jr.k8s.service.node/group:系统简称</code>，<code>污点标签</code>：<code>jr.k8s.service.node/group=系统简称:NoExecute</code>（另外需要添加是否为核心组标签，以满足后期区节点类别统计）</li>
</ul>
<blockquote>
<p>节点标签：用来保障亲和性配置标签，使拥有相同标签的服务pod优先部署在本节点上<br>污点标签：节点部署pod容忍度配置，未配置匹配容忍度将不允许被部署到该节点，并被驱逐。</p>
</blockquote>
<p><strong>注意</strong></p>
<blockquote>
<p>专属节点与核心节点：最少两个相同节点，防止节点故障（用于特殊情况指定防止影响其它系统）<br>除非核心组节点外，其它类型节点必须包含污点标签，避免其他服务注册至节点上。<br>污点标签：如果给一个节点添加了一个 effect 值为 NoExecute 的污点， 则任何不能忍受这个污点的 Pod 都会马上被驱逐<br><img src="https://opendoc.junrunrenli.com/server/index.php?s=/api/attachment/visitFile/sign/83c2ef1522d147553d9179b9b8864a87" alt="img"><br><img src="https://it.jrit.top/server/index.php?s=/api/attachment/visitFile/sign/019dff84c7107cb56aa5dc313d71fdcd" alt="img"></p>
</blockquote>
<h2 id="非核心服务亲和性配置"><a href="#非核心服务亲和性配置" class="headerlink" title="非核心服务亲和性配置"></a>非核心服务亲和性配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 定义pod标签</span></span><br><span class="line">    <span class="attr">jr-name:</span> <span class="string">jr-spms</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">jr-spms-web</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jr-spms-web</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义启动多少个pod</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">jr-spms-web</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">jr-spms-web</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 亲和性配置</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="comment"># 节点亲和性配置（建议配置亲和性。亦可不配默认，其它节点有污点标签，部署不聊。）</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="comment"># 强制只能部署节点标签为`jr.k8s.node/group:non-core`节点上</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">jr.k8s.node/group</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">non-core</span></span><br></pre></td></tr></table></figure>

<h2 id="核心服务亲和性配置"><a href="#核心服务亲和性配置" class="headerlink" title="核心服务亲和性配置"></a>核心服务亲和性配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 定义pod标签</span></span><br><span class="line">    <span class="attr">jr-name:</span> <span class="string">jr-spms</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">jr-spms</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jr-spms</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义启动多少个pod</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">jr-spms</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">jr-spms</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 亲和性配置</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="comment"># 节点亲和性配置</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="comment"># 强制只能部署节点标签为`jr.k8s.node/group:core`节点上</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">jr.k8s.node/group</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">core</span></span><br><span class="line">        <span class="comment"># pod返亲和性配置</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="comment"># 优先在没有`k8s-app:jr-spms-xxl`服务的节点部署</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">k8s-app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">jr-spms-xxl</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">      <span class="comment"># 容忍度配置</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="comment"># 允许污点标签为：`jr.k8s.node/group:core:Noexecute`节点部署该服务。</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">jr.k8s.node/group</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">core</span></span><br></pre></td></tr></table></figure>

<h2 id="任务-导出型服务亲和性配置"><a href="#任务-导出型服务亲和性配置" class="headerlink" title="任务&#x2F;导出型服务亲和性配置"></a>任务&#x2F;导出型服务亲和性配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 定义pod标签</span></span><br><span class="line">    <span class="attr">jr-name:</span> <span class="string">jr-spms</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">jr-spms-xxl</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jr-spms-xxl</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义启动多少个pod</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">jr-spms-xxl</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">jr-spms-xxl</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 亲和性配置</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="comment"># 节点亲和性配置</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="comment"># 强制只能部署节点标签为`jr.k8s.node/group:task`节点上</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">jr.k8s.node/group</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">task</span></span><br><span class="line">        <span class="comment"># pod返亲和性配置（若pod数大于2可配置pod反亲和性避免单点故障）</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="comment"># 优先在没有`k8s-app:jr-spms-xxl`服务的节点部署</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">k8s-app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">jr-spms-xxl</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">      <span class="comment"># 容忍度配置</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="comment"># 允许污点标签为：`jr.k8s.node/group:task:Noexecute`节点部署该服务。</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">jr.k8s.node/group</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">task</span></span><br></pre></td></tr></table></figure>

<h2 id="专属节点服务亲和性配置"><a href="#专属节点服务亲和性配置" class="headerlink" title="专属节点服务亲和性配置"></a>专属节点服务亲和性配置</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="comment"># 定义pod标签</span></span><br><span class="line">    <span class="attr">jr-name:</span> <span class="string">jr-spms</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">jr-spms-pay</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jr-spms-pay</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">sit</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义启动多少个pod</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">jr-spms-pay</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">jr-spms-pay</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 亲和性配置</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="comment"># 节点亲和性配置</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="comment"># 强制只能部署节点标签为`jr.k8s.service.node/group:jr-spms`且`jr.k8s.node/group:core`节点上</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">jr.k8s.service.node/group</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">jr-spms</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">jr.k8s.node/group</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">core</span></span><br><span class="line">        <span class="comment"># pod返亲和性配置</span></span><br><span class="line">        <span class="attr">podAntiAffinity:</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">podAffinityTerm:</span></span><br><span class="line">                <span class="attr">labelSelector:</span></span><br><span class="line">                  <span class="comment"># 优先在没有`k8s-app:jr-spms-xxl`服务的节点部署</span></span><br><span class="line">                  <span class="attr">matchExpressions:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">k8s-app</span></span><br><span class="line">                      <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                      <span class="attr">values:</span></span><br><span class="line">                        <span class="bullet">-</span> <span class="string">jr-spms-pay</span></span><br><span class="line">                <span class="attr">topologyKey:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">weight:</span> <span class="number">100</span></span><br><span class="line">      <span class="comment"># 容忍度配置</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">        <span class="comment"># 允许污点标签为：`jr.k8s.service.node/group:jr-spms:Noexecute`节点部署该服务。</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">effect:</span> <span class="string">NoExecute</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">jr.k8s.service.node/group</span></span><br><span class="line">          <span class="attr">operator:</span> <span class="string">Equal</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">jr-spms</span></span><br></pre></td></tr></table></figure>



<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><blockquote>
<p>K8S的调度策略有哪些？能否让K8S按照我们的期望来进行资源调度？</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">特性</th>
<th align="left">作用</th>
<th align="left">适用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>节点选择器</strong></td>
<td align="left">简单标签匹配</td>
<td align="left">简单的环境区分，如 <code>env=prod</code></td>
</tr>
<tr>
<td align="left"><strong>节点亲和性</strong></td>
<td align="left">复杂的节点标签匹配规则</td>
<td align="left">硬件类型、可用区、自定义架构要求</td>
</tr>
<tr>
<td align="left"><strong>Pod 亲和性</strong></td>
<td align="left">让 Pod 靠近其他 Pod</td>
<td align="left">微服务间需要低延迟通信</td>
</tr>
<tr>
<td align="left"><strong>Pod 反亲和性</strong></td>
<td align="left">让 Pod 远离其他 Pod</td>
<td align="left">高可用、避免资源竞争、故障隔离</td>
</tr>
<tr>
<td align="left"><strong>污点和容忍度</strong></td>
<td align="left">让节点排斥 Pod</td>
<td align="left">专用节点、故障隔离、基于节点的特权</td>
</tr>
</tbody></table>
<blockquote>
<p>K8S是怎么进行域名解析的？为什么通过创建的service名称进行接口调用可以转发至pod服务？</p>
</blockquote>
<p>K8S 集群内置了一个 <strong>DNS 服务</strong>，通常是 <strong>CoreDNS</strong>（早期版本是 kube-dns）。这个 DNS 服务作为集群的”电话簿”，为各种资源提供名称解析。</p>
<p><strong>步骤 1：Service 的创建与 Endpoint 的维护</strong></p>
<p>当你创建一个 Service（比如叫 <code>my-service</code>）时，K8S 会做两件事：</p>
<ol>
<li><strong>定义一个网络端点</strong>：Service 会被分配一个虚拟的 IP 地址，称为 <strong>Cluster IP</strong>。这个 IP 在集群内部是可达的，但它是一个虚拟 IP，不像普通 IP 地址那样绑定在某张网卡上。</li>
<li><strong>创建并维护 Endpoint&#x2F;EndpointSlice 对象</strong>：K8S 会<strong>自动</strong>根据 Service 的 <strong>Label Selector</strong>，持续地查找集群中所有匹配的 Pod。然后，它将这些 Pod 的 <code>IP:Port</code> 列表存储在一个名为 <strong>Endpoint</strong> 或 <strong>EndpointSlice</strong> 的对象中。你可以把它看作是 Service 背后真实服务器的地址列表。</li>
</ol>
<p><strong>步骤 2：DNS 服务的注册</strong></p>
<p>CoreDNS 会监听 K8S API Server，当有新的 Service 被创建时，CoreDNS 会<strong>自动</strong>将其域名（<code>my-service.default.svc.cluster.local</code>）和 Cluster IP 地址记录到它的 DNS 记录中。</p>
<p><strong>步骤 3：Pod 内的请求发起与解析</strong></p>
<p>现在，当一个 Pod（我们称之为 <code>client-pod</code>）想要调用 <code>my-service</code> 服务时：</p>
<ol>
<li>你在 <code>client-pod</code> 的代码里使用了一个 URL，例如 <code>http://my-service:8080/api</code>。</li>
<li>操作系统会发起一个 DNS 查询，请求解析 <code>my-service</code>。</li>
<li>由于 Pod 的 <code>/etc/resolv.conf</code> 文件被 K8S 自动配置，它会指向集群的 CoreDNS 服务地址。</li>
<li>DNS 查询请求被发送到 CoreDNS。</li>
<li>CoreDNS 查找自己的记录，发现 <code>my-service</code> 对应着 Cluster IP（例如 <code>10.96.1.2</code>），于是将这个 IP 地址返回给 <code>client-pod</code>。</li>
</ol>
<p><strong>步骤 4：流量转发与负载均衡</strong></p>
<ol>
<li><code>client-pod</code> 拿到 IP 地址 <code>10.96.1.2</code> 后，向这个地址发送网络请求。</li>
<li>这个虚拟 IP 被 K8S 的<strong>网络插件</strong>（如 Calico, Flannel 等）和每个节点上的 <strong>kube-proxy</strong> 组件所感知。</li>
<li><strong>kube-proxy</strong> 在这个虚拟 IP 和真实 Pod IP 之间建立了转发规则（可能是 iptables 或 ipvs 规则）。</li>
<li>当请求到达 <code>10.96.1.2</code> 时，这些网络规则会<strong>拦截</strong>该请求，并根据负载均衡策略（默认是轮询），将其转发到 <code>Endpoint</code> 列表中的某一个 Pod 的真实 IP 和端口上。</li>
</ol>
<blockquote>
<p>K8S如何做为配置中心并实现配置文件的热更新？</p>
</blockquote>
<ol>
<li>将 ConfigMap 或 Secret 作为一个卷（Volume）挂载到 Pod 的容器中。</li>
<li>K8S 会在挂载的目录下创建对应的文件（如 <code>/etc/config/redis-config.conf</code>）。</li>
<li>当更新 ConfigMap（<code>kubectl apply -f updated-configmap.yaml</code>）时，K8S 会自动将新内容<strong>投射</strong>到已挂载该卷的所有 Pod 中。</li>
<li>这个”投射”动作是<strong>异步</strong>的，但通常很快（几秒到几十秒）。</li>
<li>投射完成后，容器内看到的就是一个<strong>文件内容被更新</strong>的文件。</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://palette-k.github.io">Palette</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://palette-k.github.io/2025/07/09/kubernetes/">https://palette-k.github.io/2025/07/09/kubernetes/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://palette-k.github.io" target="_blank">Palette</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="https://i0.hdslb.com/bfs/new_dyn/d6dbf7f189becdb2a1d2a843b67d4a7623452635.jpg@1192w.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/07/14/uhr%E8%80%83%E5%8B%A4%E6%A8%A1%E5%9D%97%E6%A0%B8%E5%BF%83%E4%B8%9A%E5%8A%A1%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91/" title="uhr考勤"><img class="cover" src="https://i0.hdslb.com/bfs/new_dyn/95b2aa120db1052c42e673ae0bc9be1123452635.jpg@1192w.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">uhr考勤</div></div></a></div><div class="next-post pull-right"><a href="/2025/07/09/docker%E7%9A%84%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/" title="docker的使用技巧"><img class="cover" src="https://i0.hdslb.com/bfs/new_dyn/0e42c887b323e542e3907df1b430261023452635.jpg@1192w.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">docker的使用技巧</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">Valine</span><span class="switch-btn"></span><span class="second-comment">Disqus</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div><div><div id="disqus_thread"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://i0.hdslb.com/bfs/openplatform/bbcfc80924d36130665348ba84604566a29ccdc1.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Palette</div><div class="author-info__description">这是一个终身学习的时代</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">62</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/Palette-k"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/Palette-k" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="mailto:1148432487@gq.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><style>
.announcement-card {
    --main-color: #ff00ff;
    --secondary-color: #00ffff;
    --highlight-color: #ff5500;
    position: relative;
    overflow: hidden;
}
.announcement-content {
    font-size: 1rem; 
    line-height: 1.2; 
    color: #000000;
    position: relative;
}
.keyword {
    color: #000000;
    font-weight: 300;
    font-size: 1.1rem; 
}
.highlight {
    color: #000000;
    font-weight: 1000;
    font-size: 1.2rem; 
}
.announcement-content ul {
    list-style-type: none;
    margin: 0.8rem 0; 
    padding-left: 1.5rem;   
}
</style>
<div class="announcement-card">
    <div class="announcement-content">
        <p><span class="highlight">欢迎来到「Palette」个人技术博客</span>！🎉</p>
        <p><strong>本平台专注于：</strong></p>
        <ul>
            <li><span class="keyword">> JAVA后端技术笔记</span></li>
            <li><span class="keyword">> 场景设计解决方案</span></li>
            <li><span class="keyword">> AI应用实践</span></li>
        </ul>
        <p>🌟 <strong>一起钻研技术，共同进步！</strong></p>
    </div>
</div>
</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">基本架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Master-Node"><span class="toc-number">2.1.</span> <span class="toc-text">Master Node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Worker-Node"><span class="toc-number">2.2.</span> <span class="toc-text">Worker Node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">工作流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE"><span class="toc-number">3.</span> <span class="toc-text">安装配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kuboard"><span class="toc-number">3.1.</span> <span class="toc-text">Kuboard</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API%E5%AF%B9%E8%B1%A1"><span class="toc-number">4.</span> <span class="toc-text">API对象</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod"><span class="toc-number">4.1.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Job-CronJob"><span class="toc-number">4.2.</span> <span class="toc-text">Job&#x2F;CronJob</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment%EF%BC%9A%E8%AE%A9%E5%BA%94%E7%94%A8%E6%B0%B8%E4%B8%8D%E5%AE%95%E6%9C%BA"><span class="toc-number">4.3.</span> <span class="toc-text">Deployment：让应用永不宕机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DaemonSet%EF%BC%9A%E8%8A%82%E7%82%B9%E7%9A%84%E5%AE%88%E6%8A%A4%E8%80%85"><span class="toc-number">4.4.</span> <span class="toc-text">DaemonSet：节点的守护者</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%B3%A8%E5%85%A5"><span class="toc-number">5.1.</span> <span class="toc-text">环境变量注入</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%8A%A0%E8%BD%BD%E6%B3%A8%E5%85%A5"><span class="toc-number">5.2.</span> <span class="toc-text">文件加载注入</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Service%EF%BC%9A%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%9E%B6%E6%9E%84%E7%9A%84%E5%BA%94%E5%AF%B9%E4%B9%8B%E9%81%93"><span class="toc-number">6.</span> <span class="toc-text">Service：微服务架构的应对之道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#namespace"><span class="toc-number">6.1.</span> <span class="toc-text">namespace</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ingress%EF%BC%9A%E9%9B%86%E7%BE%A4%E8%BF%9B%E5%87%BA%E6%B5%81%E9%87%8F%E7%9A%84%E6%80%BB%E7%AE%A1"><span class="toc-number">7.</span> <span class="toc-text">Ingress：集群进出流量的总管</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IngressClass"><span class="toc-number">7.1.</span> <span class="toc-text">IngressClass</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#PersistentVolume%EF%BC%9A%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">8.</span> <span class="toc-text">PersistentVolume：数据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PersistentVolumeClaim"><span class="toc-number">8.1.</span> <span class="toc-text">PersistentVolumeClaim</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StorageClass"><span class="toc-number">8.2.</span> <span class="toc-text">StorageClass</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#StatefulSet%EF%BC%9A%E7%AE%A1%E7%90%86%E6%9C%89%E7%8A%B6%E6%80%81%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">9.</span> <span class="toc-text">StatefulSet：管理有状态的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet%E7%9A%84%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">9.1.</span> <span class="toc-text">StatefulSet的数据持久化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BB%9A%E5%8A%A8%E6%9B%B4%E6%96%B0%EF%BC%9A%E5%B9%B3%E6%BB%91%E7%9A%84%E5%BA%94%E7%94%A8%E5%8D%87%E9%99%8D%E7%BA%A7"><span class="toc-number">10.</span> <span class="toc-text">滚动更新：平滑的应用升降级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%8D%87%E7%BA%A7"><span class="toc-number">10.1.</span> <span class="toc-text">应用升级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%9B%9E%E6%BB%9A"><span class="toc-number">10.2.</span> <span class="toc-text">应用回滚</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E4%BF%9D%E9%9A%9C%EF%BC%9A%E5%A6%82%E4%BD%95%E8%AE%A9Pod%E8%BF%90%E8%A1%8C%E5%BE%97%E6%9B%B4%E5%81%A5%E5%BA%B7%EF%BC%9F"><span class="toc-number">11.</span> <span class="toc-text">应用保障：如何让Pod运行得更健康？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">11.1.</span> <span class="toc-text">容器资源配额</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%8A%B6%E6%80%81%E6%8E%A2%E9%92%88"><span class="toc-number">11.2.</span> <span class="toc-text">容器状态探针</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86%EF%BC%9A%E5%A6%82%E4%BD%95%E7%94%A8%E5%90%8D%E5%AD%97%E7%A9%BA%E9%97%B4%E5%88%86%E9%9A%94%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%EF%BC%9F"><span class="toc-number">12.</span> <span class="toc-text">集群管理：如何用名字空间分隔系统资源？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">12.1.</span> <span class="toc-text">资源配额</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E8%B5%84%E6%BA%90%E9%85%8D%E9%A2%9D"><span class="toc-number">12.2.</span> <span class="toc-text">默认资源配额</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8Metrics-Server%E5%92%8CPrometheus%EF%BC%9F"><span class="toc-number">13.</span> <span class="toc-text">系统监控：如何使用Metrics Server和Prometheus？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Metrics-Server"><span class="toc-number">13.1.</span> <span class="toc-text">Metrics Server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HorizontalPodAutoscaler"><span class="toc-number">13.2.</span> <span class="toc-text">HorizontalPodAutoscaler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prometheus"><span class="toc-number">13.3.</span> <span class="toc-text">Prometheus</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E9%80%9A%E4%BF%A1"><span class="toc-number">14.</span> <span class="toc-text">网络通信</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%85%E9%83%A8k8s%E4%BA%B2%E5%92%8C%E6%80%A7%E9%85%8D%E7%BD%AE%E8%A7%84%E8%8C%83%E8%AF%B4%E6%98%8E"><span class="toc-number">15.</span> <span class="toc-text">内部k8s亲和性配置规范说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E4%BA%B2%E5%92%8C%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">15.1.</span> <span class="toc-text">非核心服务亲和性配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%9C%8D%E5%8A%A1%E4%BA%B2%E5%92%8C%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">15.2.</span> <span class="toc-text">核心服务亲和性配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1-%E5%AF%BC%E5%87%BA%E5%9E%8B%E6%9C%8D%E5%8A%A1%E4%BA%B2%E5%92%8C%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">15.3.</span> <span class="toc-text">任务&#x2F;导出型服务亲和性配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%93%E5%B1%9E%E8%8A%82%E7%82%B9%E6%9C%8D%E5%8A%A1%E4%BA%B2%E5%92%8C%E6%80%A7%E9%85%8D%E7%BD%AE"><span class="toc-number">15.4.</span> <span class="toc-text">专属节点服务亲和性配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-number">16.</span> <span class="toc-text">扩展</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/21/%E7%BC%93%E5%AD%98%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E6%88%98/" title="缓存最终一致性与强一致性实战"><img src="https://i0.hdslb.com/bfs/new_dyn/d6dbf7f189becdb2a1d2a843b67d4a7623452635.jpg@1192w.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="缓存最终一致性与强一致性实战"/></a><div class="content"><a class="title" href="/2025/10/21/%E7%BC%93%E5%AD%98%E6%9C%80%E7%BB%88%E4%B8%80%E8%87%B4%E6%80%A7%E4%B8%8E%E5%BC%BA%E4%B8%80%E8%87%B4%E6%80%A7%E5%AE%9E%E6%88%98/" title="缓存最终一致性与强一致性实战">缓存最终一致性与强一致性实战</a><time datetime="2025-10-21T10:16:44.000Z" title="发表于 2025-10-21 18:16:44">2025-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/21/%E7%8E%A9%E8%BD%ACAI%E5%BA%94%E7%94%A81%EF%BC%9AAI%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1/" title="玩转AI应用1：AI实现代码评审"><img src="https://i0.hdslb.com/bfs/article/69b4aad1f0baf8cf5470db7f34a5724e23452635.jpg@1192w.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="玩转AI应用1：AI实现代码评审"/></a><div class="content"><a class="title" href="/2025/10/21/%E7%8E%A9%E8%BD%ACAI%E5%BA%94%E7%94%A81%EF%BC%9AAI%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81%E8%AF%84%E5%AE%A1/" title="玩转AI应用1：AI实现代码评审">玩转AI应用1：AI实现代码评审</a><time datetime="2025-10-21T03:20:54.000Z" title="发表于 2025-10-21 11:20:54">2025-10-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/17/RocketMQ%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B%E6%8F%90%E5%8D%87AI%E9%80%9A%E4%BF%A1%E6%95%88%E7%8E%87/" title="RocketMQ消息模型提升AI通信效率"><img src="https://i0.hdslb.com/bfs/article/69b4aad1f0baf8cf5470db7f34a5724e23452635.jpg@1192w.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="RocketMQ消息模型提升AI通信效率"/></a><div class="content"><a class="title" href="/2025/10/17/RocketMQ%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9E%8B%E6%8F%90%E5%8D%87AI%E9%80%9A%E4%BF%A1%E6%95%88%E7%8E%87/" title="RocketMQ消息模型提升AI通信效率">RocketMQ消息模型提升AI通信效率</a><time datetime="2025-10-17T06:49:26.000Z" title="发表于 2025-10-17 14:49:26">2025-10-17</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By Palette</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my blog!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: '',
      appKey: '',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !true) {
  if (true) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script><script>function loadDisqus () {
  const disqus_config = function () {
    this.page.url = 'https://palette-k.github.io/2025/07/09/kubernetes/'
    this.page.identifier = '/2025/07/09/kubernetes/'
    this.page.title = 'kubernetes'
  }

  const disqusReset = () => {
    DISQUS.reset({
      reload: true,
      config: disqus_config
    })
  }

  btf.addModeChange('disqus', disqusReset)

  if (window.DISQUS) disqusReset()
  else {
    (function() { 
      var d = document, s = d.createElement('script');
      s.src = 'https://.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  }
}

if ('Valine' === 'Disqus' || !true) {
  if (true) btf.loadComment(document.getElementById('disqus_thread'), loadDisqus)
  else loadDisqus()
} else {
  function loadOtherComment () {
    loadDisqus()
  }
}
</script></div><script type="text/javascript" src="/js/article.js"></script><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="false"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="algolia-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="search-wrap"><div id="algolia-search-input"></div><hr/><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-info"><div class="algolia-stats"></div><div class="algolia-poweredBy"></div></div></div></div></div><div id="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/algoliasearch/dist/algoliasearch-lite.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instantsearch.js/dist/instantsearch.production.min.js"></script><script src="/js/search/algolia.js"></script></div></div><!-- hexo injector body_end start --><script data-pjax>
    function butterfly_categories_card_injector_config(){
      var parent_div_git = document.getElementById('recent-posts');
      var item_html = '<style>li.categoryBar-list-item{width:24%;}.categoryBar-list{max-height: 380px;overflow:auto;}.categoryBar-list::-webkit-scrollbar{width:0!important}@media screen and (max-width: 650px){.categoryBar-list{max-height: 320px;}}</style><div class="recent-post-item" style="height:auto;width:100%;padding:0px;"><div id="categoryBar"><ul class="categoryBar-list"><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover1.webp);"> <a class="categoryBar-list-link" href="/categories/Spring/">Spring</a><span class="categoryBar-list-count">4</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover2.webp);"> <a class="categoryBar-list-link" href="/categories/安全/">安全</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover3.webp);"> <a class="categoryBar-list-link" href="/categories/AI/">AI</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover4.webp);"> <a class="categoryBar-list-link" href="/categories/JVM/">JVM</a><span class="categoryBar-list-count">5</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover5.webp);"> <a class="categoryBar-list-link" href="/categories/k8s/">k8s</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover6.webp);"> <a class="categoryBar-list-link" href="/categories/场景/">场景</a><span class="categoryBar-list-count">8</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover1.webp);"> <a class="categoryBar-list-link" href="/categories/JUC/">JUC</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover2.webp);"> <a class="categoryBar-list-link" href="/categories/MyBatis/">MyBatis</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover3.webp);"> <a class="categoryBar-list-link" href="/categories/maven/">maven</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover4.webp);"> <a class="categoryBar-list-link" href="/categories/MySQL/">MySQL</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover5.webp);"> <a class="categoryBar-list-link" href="/categories/缓存/">缓存</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover6.webp);"> <a class="categoryBar-list-link" href="/categories/RocketMQ/">RocketMQ</a><span class="categoryBar-list-count">10</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover1.webp);"> <a class="categoryBar-list-link" href="/categories/SSE/">SSE</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover2.webp);"> <a class="categoryBar-list-link" href="/categories/SSO/">SSO</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover3.webp);"> <a class="categoryBar-list-link" href="/categories/Docker/">Docker</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover4.webp);"> <a class="categoryBar-list-link" href="/categories/java/">java</a><span class="categoryBar-list-count">2</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover5.webp);"> <a class="categoryBar-list-link" href="/categories/日志/">日志</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover6.webp);"> <a class="categoryBar-list-link" href="/categories/nginx/">nginx</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover1.webp);"> <a class="categoryBar-list-link" href="/categories/WebSocket/">WebSocket</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover2.webp);"> <a class="categoryBar-list-link" href="/categories/xxl-job/">xxl-job</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover3.webp);"> <a class="categoryBar-list-link" href="/categories/算法/">算法</a><span class="categoryBar-list-count">3</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover4.webp);"> <a class="categoryBar-list-link" href="/categories/netty/">netty</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover5.webp);"> <a class="categoryBar-list-link" href="/categories/git/">git</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li><li class="categoryBar-list-item" style="background:url(https://npm.elemecdn.com/akilar-candyassets/image/cover6.webp);"> <a class="categoryBar-list-link" href="/categories/设计模式/">设计模式</a><span class="categoryBar-list-count">1</span><span class="categoryBar-list-descr"></span></li></ul></div></div>';
      console.log('已挂载butterfly_categories_card')
      parent_div_git.insertAdjacentHTML("afterbegin",item_html)
      }
    if( document.getElementById('recent-posts') && (location.pathname ==='/'|| '/' ==='all')){
    butterfly_categories_card_injector_config()
    }
  </script><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementsByClassName('recent-posts')[0];
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/10/21/玩转AI应用1：AI实现代码评审/" alt=""><img width="48" height="48" src="https://i0.hdslb.com/bfs/article/69b4aad1f0baf8cf5470db7f34a5724e23452635.jpg@1192w.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-21</span><a class="blog-slider__title" href="2025/10/21/玩转AI应用1：AI实现代码评审/" alt="">玩转AI应用1：AI实现代码评审</a><div class="blog-slider__text">介绍 AI 实现自动 code review 的技术方案</div><a class="blog-slider__button" href="2025/10/21/玩转AI应用1：AI实现代码评审/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/09/12/如何设计一个秒杀系统/" alt=""><img width="48" height="48" src="https://i0.hdslb.com/bfs/article/69b4aad1f0baf8cf5470db7f34a5724e23452635.jpg@1192w.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-12</span><a class="blog-slider__title" href="2025/09/12/如何设计一个秒杀系统/" alt="">如何设计一个秒杀系统</a><div class="blog-slider__text">关于秒杀场景设计思路拓展</div><a class="blog-slider__button" href="2025/09/12/如何设计一个秒杀系统/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/10/17/RocketMQ消息模型提升AI通信效率/" alt=""><img width="48" height="48" src="https://i0.hdslb.com/bfs/article/69b4aad1f0baf8cf5470db7f34a5724e23452635.jpg@1192w.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-10-17</span><a class="blog-slider__title" href="2025/10/17/RocketMQ消息模型提升AI通信效率/" alt="">RocketMQ消息模型提升AI通信效率</a><div class="blog-slider__text">Apache RocketMQ 顺应AIGC浪潮，针对长时会话、稀缺算力调度及AI Agent协作等挑战，推出专为AI时代打造的消息引擎。</div><a class="blog-slider__button" href="2025/10/17/RocketMQ消息模型提升AI通信效率/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/09/22/AI可以做什么/" alt=""><img width="48" height="48" src="https://i0.hdslb.com/bfs/new_dyn/95b2aa120db1052c42e673ae0bc9be1123452635.jpg@1192w.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-09-22</span><a class="blog-slider__title" href="2025/09/22/AI可以做什么/" alt="">AI可以做什么？</a><div class="blog-slider__text">AI基本概念原理及新玩法</div><a class="blog-slider__button" href="2025/09/22/AI可以做什么/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>